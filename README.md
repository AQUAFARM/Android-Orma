# Orma for Android [![Circle CI](https://circleci.com/gh/gfx/Android-Orma/tree/master.svg?style=svg)](https://circleci.com/gh/gfx/Android-Orma/tree/master) [ ![Download](https://api.bintray.com/packages/gfx/maven/orma/images/download.svg) ](https://bintray.com/gfx/maven/orma/_latestVersion)

Orma is a lightning-fast ORM for Android, generating DAO at compile time with annotation processing.

Model classes that are handled by Orma has no restriction: you can define just a POJO class with Orma annotations.

Note that this is an **alpha** software and the interface will change until a stable version is released.

# Install

```groovy
dependencies {
    apt 'com.github.gfx.android.orma:orma-processor:0.2.0'
    provided 'com.github.gfx.android.orma:orma-annotations:0.2.0'
    compile 'com.github.gfx.android.orma:orma:0.2.0'
}
```

# Synopsis

First, define model classes annotated with `@Table`, `@Column`, and `@PrimaryKey`.

```java
package com.github.gfx.android.orma.example;

import com.github.gfx.android.orma.annotation.Column;
import com.github.gfx.android.orma.annotation.PrimaryKey;
import com.github.gfx.android.orma.annotation.Table;

import android.support.annotation.Nullable;

@Table
public class Todo {

    @PrimaryKey
    public long id;

    @Column(indexed = true)
    public String title;

    @Column
    @Nullable
    public String content;

    @Column
    public long createdTimeMillis;
}
```

Second, create a database handle `OrmaDatabase`, which is generated by `orma-processor`.

```java
OrmaDatabase orma = new OrmaDatabase(context, "orma.db");
orma.addTypeAdapters(TypeAdapterRegistry.defaultTypeAdapters());
```

Then, you can create, read, update and delete models.

```java
Todo todo = ...;

// create
orma.insertIntoTodo(todo);

// prepared statements with transaction
orma.transaction( -> {
    Inserter<Todo> inserter = orma.prepareInsertIntoTodo();
    inserter.execute(todo);
});

// read
orma.selectFromTodo()
  .where("title = ?", "foo")
  .toList();

// update
orma.updateTodo()
  .where("title = ?", "foo")
  .content("a new content")
  .execute();

// delete
orma.deleteTodo()
  .where("title = ?", "foo")
  .execute();
```

(this document is working in progress.)

# Models

## Accessors

You can define private columns with `@Getter` and `@Setter`, which tells `orma-processor` to use accessors.

```
@Table
public class KeyValuePair {

    @Column
    private String key;

    @Column
    private String value;

    @Getter("key")
    public String getKey() {
        return key;
    }

    @Setter("key")
    public void setKey(String key) {
        this.key = key;
    }

    @Getter("value")
    public String getValue() {
        return value;
    }

    @Setter("value")
    public void setValue(String value) {
        this.value = value;
    }
}
```

# Migration

The default migration engine, `SchemaDiffMigration`, can handle column additions and removal.

You can also set a custom migration engine:

```java
class CustomMigrationEngine implements MigrationEngine { ... }

OrmaDatabase orma = new OrmaDatabase(context, "orma.db", new CustomMigrationEngine());
```

See [migration/] for details.

(TODO: more concise description)

# Type Adapters

Type adapters, which serializes and deserializes custom classes, are supported.

If you use type adapters, you can add them to `OrmaDatabase`:

```
class FooAdapter extends AbstractTypeAdapter<Foo> {
    @Override
    public String serialize(Foo source) {
        return ... serialize ...;
    }

    @Override
    public Foo deserialize(String serialized) {
        return ... deserialize ...;
    }
}


OrmaDatabase orma = ...;
orma.addTypeAdapters(TypeAdapterRegistry.defaultTypeAdapters()); // add defaults
orma.addTypeAdapters(new FooAdapter());
```

# Release Engineering

```shell
./gradlew bumpMajor # or bumpMinor / bumpPatch
./gradlew check bintrayUpload -PdryRun=true
./gradlew annotations:bintrayUpload processor:bintrayUpload library:bintrayUpload
```

# Licenses in Runtime Dependencies

* https://github.com/ReactiveX/RxJava - Apache Software License 2.0
* https://github.com/JSQLParser/JSqlParser - LGPL v2.1 and Apache Software License 2.0 (dual licenses)

# Author

FUJI Goro (gfx).

# License

The MIT License.
